% configurar_funciones_simple.m
% Muestra las funciones que debes copiar

fprintf('\\n');
fprintf('??????????????????????????????????????????????????????????????\\n');
fprintf('  FUNCIONES PARA COPIAR EN LOS BLOQUES MATLAB FUNCTION\\n');
fprintf('??????????????????????????????????????????????????????????????\\n\\n');

fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('BLOQUE: GenLlegadas (en AM y FM)\\n');
fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('function nueva_llegada = GenLlegadas(entrada)\\n');
fprintf('persistent t_prox;\\n');
fprintf('if isempty(t_prox)\\n');
fprintf('    t_prox = 0;\\n');
fprintf('end\\n');
fprintf('t = entrada(1);\\n');
fprintf('lambda = entrada(2);\\n');
fprintf('u = entrada(3);\\n');
fprintf('nueva_llegada = 0;\\n');
fprintf('if t >= t_prox\\n');
fprintf('    nueva_llegada = 1;\\n');
fprintf('    dt = -log(u) / lambda;\\n');
fprintf('    t_prox = t + dt;\\n');
fprintf('end\\n');
fprintf('\\n\\n');

fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('BLOQUE: AsigCliente (en AM y FM)\\n');
fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('function salida = AsigCliente(entrada)\\n');
fprintf('u_tipo = entrada(1);\\n');
fprintf('u_bw = entrada(2);\\n');
fprintf('prob_movil = entrada(3);\\n');
fprintf('if u_tipo < prob_movil\\n');
fprintf('    media = 80;\\n');
fprintf('    desv = 25;\\n');
fprintf('else\\n');
fprintf('    media = 150;\\n');
fprintf('    desv = 30;\\n');
fprintf('end\\n');
fprintf('z = sqrt(-2*log(u_bw)) * cos(2*pi*u_bw);\\n');
fprintf('BW = max(media + desv * z, 32);\\n');
fprintf('salida = [BW; u_tipo];\\n');
fprintf('\\n\\n');

fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('BLOQUE: Cola128, Cola96, Cola64 (MISMA FUNCIÓN PARA LOS 3)\\n');
fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('function salida = Cola128(entrada)\\n');
fprintf('persistent cola serv_libres clientes_serv stats;\\n');
fprintf('if isempty(cola)\\n');
fprintf('    cola = [];\\n');
fprintf('    serv_libres = 3;\\n');
fprintf('    clientes_serv = zeros(3,2);\\n');
fprintf('    stats = [0;0;0;0];\\n');
fprintf('end\\n');
fprintf('llegada = entrada(1);\\n');
fprintf('BW_cli = entrada(2);\\n');
fprintf('vel = entrada(3);\\n');
fprintf('t = entrada(4);\\n');
fprintf('acept = 0;\\n');
fprintf('rech = 0;\\n');
fprintf('slow = 0;\\n');
fprintf('for i=1:3\\n');
fprintf('    if clientes_serv(i,1)>0 && t>=clientes_serv(i,1)\\n');
fprintf('        clientes_serv(i,:)=[0,0];\\n');
fprintf('        serv_libres=serv_libres+1;\\n');
fprintf('        if ~isempty(cola)\\n');
fprintf('            c=cola(1,:);\\n');
fprintf('            cola(1,:)=[];\\n');
fprintf('            serv_libres=serv_libres-1;\\n');
fprintf('            ts=-log(rand())/0.00333;\\n');
fprintf('            clientes_serv(i,:)=[t+ts,c(2)];\\n');
fprintf('            stats(1)=stats(1)+1;\\n');
fprintf('        end\\n');
fprintf('    end\\n');
fprintf('end\\n');
fprintf('if llegada==1\\n');
fprintf('    stats(4)=stats(4)+1;\\n');
fprintf('    if BW_cli<vel*1.1\\n');
fprintf('        rech=1;\\n');
fprintf('        slow=1;\\n');
fprintf('        stats(2)=stats(2)+1;\\n');
fprintf('    elseif serv_libres>0\\n');
fprintf('        acept=1;\\n');
fprintf('        serv_libres=serv_libres-1;\\n');
fprintf('        ts=-log(rand())/0.00333;\\n');
fprintf('        for i=1:3\\n');
fprintf('            if clientes_serv(i,1)==0\\n');
fprintf('                clientes_serv(i,:)=[t+ts,BW_cli];\\n');
fprintf('                break;\\n');
fprintf('            end\\n');
fprintf('        end\\n');
fprintf('        stats(1)=stats(1)+1;\\n');
fprintf('    elseif size(cola,1)<50\\n');
fprintf('        cola=[cola;t,BW_cli];\\n');
fprintf('    else\\n');
fprintf('        rech=1;\\n');
fprintf('        stats(3)=stats(3)+1;\\n');
fprintf('    end\\n');
fprintf('end\\n');
fprintf('n_cola=size(cola,1);\\n');
fprintf('serv_ocup=3-serv_libres;\\n');
fprintf('salida=[acept;rech;n_cola;serv_ocup;slow];\\n');
fprintf('\\n\\n');

fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('BLOQUE: Recolector (en AM y FM)\\n');
fprintf('?????????????????????????????????????????????????????????????\\n');
fprintf('function salida = Recolector(entrada)\\n');
fprintf('persistent stats;\\n');
fprintf('if isempty(stats)\\n');
fprintf('    stats = zeros(3,1);\\n');
fprintf('end\\n');
fprintf('a1=entrada(1); r1=entrada(2); s1=entrada(3);\\n');
fprintf('a2=entrada(4); r2=entrada(5); s2=entrada(6);\\n');
fprintf('a3=entrada(7); r3=entrada(8); s3=entrada(9);\\n');
fprintf('stats(1)=stats(1)+a1+a2+a3;\\n');
fprintf('stats(2)=stats(2)+r1+r2+r3;\\n');
fprintf('stats(3)=stats(3)+s1+s2+s3;\\n');
fprintf('total=stats(1)+stats(2);\\n');
fprintf('if total>0\\n');
fprintf('    tasa_exito=stats(1)/total*100;\\n');
fprintf('    tasa_slow=stats(3)/total*100;\\n');
fprintf('else\\n');
fprintf('    tasa_exito=0;\\n');
fprintf('    tasa_slow=0;\\n');
fprintf('end\\n');
fprintf('salida=[tasa_exito; tasa_slow; stats(1)];\\n');
fprintf('\\n\\n');

fprintf('??????????????????????????????????????????????????????????????\\n');
fprintf('  PASOS PARA CONFIGURAR:\\n');
fprintf('??????????????????????????????????????????????????????????????\\n\\n');

fprintf('1. Abre el modelo:\\n');
fprintf('   >> open_system(''icecast_modelo'')\\n\\n');

fprintf('2. Doble clic en subsistema AM\\n\\n');

fprintf('3. Para CADA bloque MATLAB Function:\\n');
fprintf('   - Doble clic en el bloque\\n');
fprintf('   - BORRA el código que viene por defecto\\n');
fprintf('   - COPIA la función de arriba\\n');
fprintf('   - CTRL+S para guardar\\n\\n');

fprintf('   Bloques a configurar en AM:\\n');
fprintf('   ? GenLlegadas\\n');
fprintf('   ? AsigCliente\\n');
fprintf('   ? Cola128 (usar código de Cola128)\\n');
fprintf('   ? Cola96 (usar código de Cola128)\\n');
fprintf('   ? Cola64 (usar código de Cola128)\\n');
fprintf('   ? Recolector\\n\\n');

fprintf('4. Repite para subsistema FM\\n');
fprintf('   (Mismas funciones, mismo procedimiento)\\n\\n');

fprintf('5. Ejecutar simulación:\\n');
fprintf('   >> sim(''icecast_modelo'')\\n\\n');

fprintf('6. Ver resultados:\\n');
fprintf('   >> ver_resultados\\n\\n');

fprintf('??????????????????????????????????????????????????????????????\\n');